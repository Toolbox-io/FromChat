services:
  backend:
    build: 
      dockerfile: deployment/Dockerfile.backend
      context: ..
    environment:
      PORT: 8300
      JWT_SECRET: ${JWT_SECRET}
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
    volumes:
      - "data:/app/data"
    develop:
      watch:
        - action: sync+restart
          path: ../backend
          target: /app
        - action: rebuild
          path: ../backend/requirements.txt
    networks:
      - main

  frontend:
    build: 
      dockerfile: deployment/frontend/Dockerfile
      context: ..
    environment:
      PORT: 8301
      BACKEND_HOST: http://backend:8300
    ports:
      - "8301:8301"
    depends_on:
      - backend
    develop:
      watch:
        - action: rebuild
          path: ../frontend
        - action: sync+restart
          path: server.js
          target: /server/server.js
        - action: rebuild
          path: package.json
    networks:
      - main
      - default

volumes:
  data:
    name: fromchat-data

networks:
  main:
    driver: bridge
    internal: true # isolate from the outside world